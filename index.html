<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>itter.tw</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="theme-color" content="#000">
	<style>
		
		.user img{
			height:20px;
		}
		
		.embedtweet{
			padding-left: 20px;
		}
	
		.media{
			height:100px;
		}
		
		.emoji{
			position: relative;
			height: 20px;
			top: 2px;
		}
	</style>
</head>
<body>
	<h1>itter.tw</h1>
	<ul id="timeline">
	
	</ul>
	
	<div id="tweetTemplate" style="display:none">
		<li class="tweet">
			<header>
				<a class="user" href="//twitter.com/{{twitter.user.screen_name}}" target="_blank">
					<img src="{{twitter.user.profile_image_url}}" alt"Profil picture of {{twitter.user.name}}">{{twitter.user.name}} @{{twitter.user.screen_name}}
				</a>
			</header>
			{{if twitter.retweeted_status}}
			<div class="embedtweet">
				RT
				<header>
					<a class="user" href="//twitter.com/{{twitter.retweeted_status.user.screen_name}}" target="_blank">
						<img src="{{twitter.retweeted_status.user.profile_image_url}}" alt"PP" style="height:20px">{{twitter.retweeted_status.user.name}} @{{twitter.retweeted_status.user.name}}
					</a>
				</header>
				{{preprocess.retweeted_status.tweet}}
			</div>
			{{else}}
			{{preprocess.tweet}}
			{{/if}}
		</li>
	</div>
	
	
<script src="//dav.li/jquery/2.1.4.js"></script>
<script src="//dav.li/markupjs/1.5.21.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://twemoji.maxcdn.com/2/twemoji.min.js?2.2"></script>
<script>
	var tweetTemplate = $("#tweetTemplate").html();
	
	var socket = io.connect('http://vps.dav.li:8080');
	socket.on('init', function (data) {
		console.log("//Connected to server //Client id:["+data.id+"]");
		socket.emit('init', { data: 'ping' });
	});
	socket.on('console', function (json) {
		console.log(json.data);
	});

	socket.on('timelineUpdate', function (data) {
		console.log(data);
		
		$('#timeline').prepend(Mark.up(tweetTemplate, { twitter:data.tweet, preprocess:preprocess(data.tweet)}));
	});
	
	function preprocess(tweet){
		var returndata={tweet:""};
		if(tweet.retweeted_status!=undefined){ //It's a RT
			returndata.retweeted_status=preprocess(tweet.retweeted_status);
		}else{
			returndata.tweet=tweet.text;
			//console.log(util.inspect(tweet.entities.hashtags));
			for(var i in tweet.entities.hashtags){ //hashtags
				var hashtag=tweet.entities.hashtags[i];
				returndata.tweet=returndata.tweet.replace("#"+hashtag.text,'<a class="hashtag" href="//twitter.com/hashtag/'+hashtag.text+'" target="_blank">#'+hashtag.text+'</a>');
			}
			for(var i in tweet.entities.urls){ //links
				var link=tweet.entities.urls[i];
				returndata.tweet=returndata.tweet.replace(link.url,'<a class="link" href="'+link.expanded_url+'" target="_blank">'+link.display_url+'</a>');
			}
			for(var i in tweet.entities.user_mentions){ //mention
				var mention=tweet.entities.user_mentions[i];
				returndata.tweet=returndata.tweet.replace("@"+mention.screen_name,'<a class="mention" href="//twitter.com/'+mention.screen_name+'" target="_blank">@'+mention.screen_name+'</a>');
			}
			if(tweet.extended_entities){
				for(var i in tweet.extended_entities.media){ //media
					var media=tweet.extended_entities.media[i];
					if(media.type=="photo"){
						returndata.tweet=returndata.tweet.replace(media.url,'<br/><img class="media" src="'+media.media_url_https+'" alt="" />');
					}
				}
			}
			returndata.tweet=twemoji.parse(returndata.tweet);
		}
		//console.log(returndata);
		return returndata;
	}
	
</script>
</body>
</html>
